# =============================================================================
# ArtifactKeeper iOS/macOS CI/CD Pipeline
# =============================================================================
#
# Required GitHub Secrets (for signed releases only):
#
#   APPLE_CERTIFICATE_BASE64          - Base64-encoded .p12 distribution certificate
#   APPLE_CERTIFICATE_PASSWORD        - Password for the .p12 file
#   APPLE_PROVISIONING_PROFILE_BASE64 - Base64-encoded .mobileprovision
#   APPLE_TEAM_ID                     - Apple Developer Team ID
#   APPSTORE_API_KEY_ID               - App Store Connect API Key ID (for upload)
#   APPSTORE_API_ISSUER_ID            - App Store Connect API Issuer ID
#   APPSTORE_API_PRIVATE_KEY          - App Store Connect API Private Key (.p8 contents)
#
# To encode a file as base64 for secrets:
#   base64 -i Certificates.p12 | pbcopy
#   base64 -i App.mobileprovision | pbcopy
#
# =============================================================================

name: CI/CD

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      upload_to_appstore:
        description: "Upload to App Store Connect"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  XCODE_PATH: /Applications/Xcode_16.2.app

jobs:
  build:
    name: Build
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s "$XCODE_PATH"

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: .build
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Resolve dependencies
        run: swift package resolve

      - name: Build
        run: swift build

  test:
    name: Unit Tests
    runs-on: macos-15
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s "$XCODE_PATH"

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: .build
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Run tests
        run: swift test

  nightly:
    name: Nightly Release
    runs-on: macos-15
    needs: [build, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s "$XCODE_PATH"

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Install iOS simulator runtime
        run: xcodebuild -downloadPlatform iOS

      - name: Build macOS app
        run: |
          xcodebuild build \
            -project ArtifactKeeper.xcodeproj \
            -scheme ArtifactKeeper_macOS \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package macOS app
        run: |
          APP_PATH=$(find build -name "ArtifactKeeper.app" -path "*/Release/*" | head -1)
          ditto -c -k --keepParent "$APP_PATH" ArtifactKeeper-macOS.zip

      - name: Build iOS simulator app
        run: |
          xcodebuild build \
            -project ArtifactKeeper.xcodeproj \
            -scheme ArtifactKeeper_iOS \
            -configuration Release \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath build-ios \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package iOS simulator app
        run: |
          APP_PATH=$(find build-ios -name "ArtifactKeeper.app" -path "*/Release-iphonesimulator/*" | head -1)
          ditto -c -k --keepParent "$APP_PATH" ArtifactKeeper-iOS-Simulator.zip

      - name: Update nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: "Nightly Build"
          body: |
            Latest development build from `main` branch.

            **macOS App** — Unsigned, right-click > Open to bypass Gatekeeper.
            **iOS Simulator App** — Install with `xcrun simctl install booted ArtifactKeeper.app`

            > Updated on every push to main. Not a stable release.
          prerelease: true
          make_latest: false
          files: |
            ArtifactKeeper-macOS.zip
            ArtifactKeeper-iOS-Simulator.zip

  archive-release:
    name: Archive & Release
    runs-on: macos-15
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    needs: [build]
    env:
      KEYCHAIN_NAME: build.keychain-db
      KEYCHAIN_PASSWORD: temporary-ci-password
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s "$XCODE_PATH"

      - name: Install iOS platform
        run: |
          for i in 1 2 3; do
            xcodebuild -downloadPlatform iOS && break
            echo "Retry $i..." && sleep 10
          done

      - name: Import signing certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

          security import "$CERTIFICATE_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_NAME"

          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

          security list-keychains -d user -s "$KEYCHAIN_NAME" login.keychain-db

      - name: Install provisioning profile
        env:
          APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"
          echo "$APPLE_PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"

          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< \
            "$(security cms -D -i "$PROFILE_PATH")")
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c "Print Name" /dev/stdin <<< \
            "$(security cms -D -i "$PROFILE_PATH")")
          echo "PROVISIONING_PROFILE_SPECIFIER=$PROFILE_NAME" >> "$GITHUB_ENV"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PROFILE_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/"${PROFILE_UUID}.mobileprovision"

      - name: Install App Store Connect API key
        env:
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
        run: |
          mkdir -p ~/private_keys
          echo "$APPSTORE_API_PRIVATE_KEY" > ~/private_keys/AuthKey_${APPSTORE_API_KEY_ID}.p8

      - name: Install xcodegen and generate project
        run: |
          brew install xcodegen
          xcodegen generate

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: archive-spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: archive-spm-${{ runner.os }}-

      - name: Archive for iOS
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild archive \
            -project ArtifactKeeper.xcodeproj \
            -scheme ArtifactKeeper_iOS \
            -destination 'generic/platform=iOS' \
            -archivePath "$RUNNER_TEMP/ArtifactKeeper-iOS.xcarchive" \
            -skipPackagePluginValidation \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID"

      - name: Export iOS IPA
        env:
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cat > "$RUNNER_TEMP/ExportOptions-iOS.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>teamID</key>
            <string>$APPLE_TEAM_ID</string>
            <key>uploadSymbols</key>
            <true/>
            <key>provisioningProfiles</key>
            <dict>
              <key>com.artifactkeeper.ios</key>
              <string>$PROVISIONING_PROFILE_SPECIFIER</string>
            </dict>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/ArtifactKeeper-iOS.xcarchive" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions-iOS.plist" \
            -exportPath "$RUNNER_TEMP/ios-export" \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${APPSTORE_API_KEY_ID}.p8 \
            -authenticationKeyID "$APPSTORE_API_KEY_ID" \
            -authenticationKeyIssuerID "$APPSTORE_API_ISSUER_ID"

      - name: Upload iOS IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArtifactKeeper-iOS
          path: ${{ runner.temp }}/ios-export/*.ipa
          if-no-files-found: error

      - name: Build macOS app
        run: |
          xcodebuild build \
            -project ArtifactKeeper.xcodeproj \
            -scheme ArtifactKeeper_macOS \
            -configuration Release \
            -derivedDataPath "$RUNNER_TEMP/build-macos" \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package macOS app
        run: |
          APP_PATH=$(find "$RUNNER_TEMP/build-macos" -name "ArtifactKeeper.app" -path "*/Release/*" | head -1)
          ditto -c -k --keepParent "$APP_PATH" "$RUNNER_TEMP/ArtifactKeeper-macOS.zip"

      - name: Upload macOS App artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArtifactKeeper-macOS
          path: ${{ runner.temp }}/ArtifactKeeper-macOS.zip
          if-no-files-found: error

      - name: Upload to App Store Connect
        if: >-
          (github.event_name == 'workflow_dispatch' &&
           github.event.inputs.upload_to_appstore == 'true') ||
          startsWith(github.ref, 'refs/tags/v')
        env:
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
        run: |
          IPA_PATH=$(find "$RUNNER_TEMP/ios-export" -name "*.ipa" -print -quit)
          if [ -n "$IPA_PATH" ]; then
            xcrun altool --upload-app \
              --file "$IPA_PATH" --type ios \
              --apiKey "$APPSTORE_API_KEY_ID" \
              --apiIssuer "$APPSTORE_API_ISSUER_ID"
          fi

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            ${{ runner.temp }}/ios-export/*.ipa
            ${{ runner.temp }}/ArtifactKeeper-macOS.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up keychain and credentials
        if: always()
        run: |
          security delete-keychain "$KEYCHAIN_NAME" 2>/dev/null || true
          rm -f "$RUNNER_TEMP/certificate.p12" "$RUNNER_TEMP/profile.mobileprovision"
          rm -rf ~/private_keys
